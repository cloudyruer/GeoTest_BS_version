<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- fontawesome -->
    <link rel="stylesheet" href="fontawesome/css/all.css" />
    <!-- bootstrap 4.6 -->
    <link rel="stylesheet" href="bootstrap4/css/bootstrap.css" />
    <!-- leaflet css -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />

    <style>
      body {
        background-color: #151b29;
      }

      .geo_box {
        color: #ffa260;
        border: 2px solid;
        border-radius: 5px;
      }

      .info {
        font-size: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 1.2rem;
        font-weight: bold;
      }

      .geo_btn {
        background: none;
        color: #ffa260;
        border: 2px solid;
        transition: all 0.2s;
        font-size: 1.3rem;
        font-weight: 600;
        border-radius: 20px;
      }

      .geo_btn:hover {
        border-color: #f1ff5c;
        color: #f1ff5c;
        box-shadow: 0 0.5rem 0.5rem -0.4rem #f1ff5c;
        transform: translateY(-0.25rem);
        animation-play-state: paused;
      }

      .geo_btn:active {
        transform: translateY(0);
      }

      .geo_btn_shine {
        border-color: #f1ff5c;
        color: #f1ff5c;
        box-shadow: 0 0.5rem 0.5rem -0.4rem #f1ff5c;
        transform: translateY(-0.25rem);
        animation: btnPopping 0.6s ease-in infinite alternate;
      }

      @keyframes btnPopping {
        from {
          transform: translateY(-0.25rem);
          box-shadow: 0rem 0.3rem 1.5rem 0rem #f1ff5c;
        }
        to {
          transform: translateY(0);
          box-shadow: 0 0.5rem 0.3rem -0.6rem #f1ff5c;
        }
      }

      /* NOTE map */
      #map {
        /* NOTE height setting with vh */
        height: 65vh;
        width: 100%;
      }

      /* NOTE pop up */
      /* pop up的背景 */
      .leaflet-popup .leaflet-popup-content-wrapper {
        background-color: #151b29;
        color: #ffa260;
        border-radius: 15px;
        /* padding: 3px; */
        /* padding-right: 0.6rem; */
      }
      /* pop up 背景下方的三角形 */
      .leaflet-popup .leaflet-popup-tip {
        background-color: #151b29;
      }

      /* pop div內的文字 */
      .leaflet-popup .leaflet-popup-content {
        font-size: 1rem;
      }
    </style>
    <!-- NOTE title -->
    <title>Title</title>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <!-- NOTE -->
        <a class="navbar-brand" href="#">Team &#923;</a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <!-- left side -->
          <ul class="navbar-nav mr-auto">
            <!-- NOTE temp 需要的話複製就好 不要動這個 li-->
            <li class="nav-item active">
              <a class="nav-link" href="#">Member : </a>
            </li>
          </ul>

          <!-- right side -->
          <ul class="navbar-nav">
            <!-- after log in,  will show up after login -->

            <li class="nav-item active">
              <a class="nav-link">皮卡丘</a>
            </li>

            <!-- NOTE  add $activeLi ternary-->
            <li class="nav-item">
              <a class="nav-link" href="#">編輯個人資料</a>
            </li>

            <!-- log out -->
            <li class="nav-item">
              <a class="nav-link" href="#">登出</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- navbar end -->
    <!-- NOTE start -->
    <div class="container mt-3 mt-md-4">
      <div class="row align-items-stretch">
        <div class="col-md-6 col-lg-4">
          <div
            class="
              geo_box
              d-flex
              flex-column
              justify-content-center
              align-items-center
              px-5
              h-100
            "
          >
            <!-- TODO: php -->
            <h2 class="font-weight-bold">Hi! 皮卡丘</h2>
            <h3 class="title my-4 font-weight-bold">所在位置</h3>
            <div class="info w-100 px-1">
              緯度:<span class="lat">待確認</span>
            </div>
            <div class="info w-100 px-1">
              經度:<span class="lng">待確認</span>
            </div>
            <div class="info w-100 px-1">
              城市:<span class="city">待確認</span>
            </div>
            <div class="info w-100 px-1">
              區域: <span class="locality">待確認</span>
            </div>
            <!-- for test -->
            <div class="info w-100 px-1">
              誤差:<span class="accuracy">待確認</span>
            </div>
            <button class="geo_btn mt-3 w-100 py-3">加入運動!</button>
          </div>
        </div>

        <div class="col-md-6 col-lg-8">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>

    <script>
      const titleText = document.querySelector('.title');
      const latText = document.querySelector('.lat');
      const lngText = document.querySelector('.lng');
      const cityText = document.querySelector('.city');
      const localityText = document.querySelector('.locality');
      const accuracyText = document.querySelector('.accuracy');
      const geoBtn = document.querySelector('.geo_btn');

      // NOTE 瀏覽器API 取得當前地理座標
      const geoLocation = () =>
        new Promise((resolve, reject) => {
          // WARN 此為設定檔 要再討論
          const options = {
            enableHighAccuracy: true,
            // WARN timeout:won't return until the position is available
            // maybe change to 5000?
            timeout: Infinity,
            maximumAge: 0,
          };

          //  if reject
          const userDenied = () =>
            reject(new Error('☜(ﾟヮﾟ☜) 請允許瀏覽器讀取您的位置資料 QQ'));

          navigator.geolocation.getCurrentPosition(
            resolve,
            userDenied,
            options
          );
        });

      // NOTE  geo reverse 取得當前地理位置
      const geoReverse = async (lat, lng) => {
        const revResult = await fetch(
          `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=zh`
        );

        if (!revResult.ok) throw new Error('Problem with geoReverse');

        const finalResult = await revResult.json();
        return finalResult;
      };

      //  NOTE Map
      //   create map 使用資策會當作初始地點 zoom 17 -> zoom 14 (once btn fired)
      const map = L.map('map').setView([25.03382, 121.5434], 17);
      // console.log(map);

      //   https://wiki.openstreetmap.org/wiki/Tile_servers
      //   add tile layer to map  NOTE another .org -> .fr/hot
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // init popup -> would be removed once btn is fired
      const initMarker = L.marker([25.03382, 121.5434])
        .addTo(map)
        .bindPopup('我們的公司在這裡歐👍')
        .openPopup();

      // NOTE 有時間可討論看看 甚麼時間點 remove initMarker (暫定為全視窗)
      window.addEventListener('click', () => initMarker.remove());

      // 顯示當前位置 點擊新的時候移除先前的
      let userPick;
      map.on('click', mapEvent => {
        console.log(mapEvent);
        // console.log(mapEvent.latlng);
        const { lat, lng } = mapEvent.latlng;
        console.log(lat, lng);

        userPick?.remove();
        userPick = L.marker([lat, lng])
          .addTo(map)
          .bindPopup(
            L.popup({
              maxWidth: 250,
              minWidth: 100,
              autoClose: false,
              closeOnClick: false,
              className: 'map_icon',
            })
          )
          .setPopupContent('你點的位置')
          .openPopup();
        console.log(userPick);
      });

      /*
        const mapRender = (lat = 25.03382, lng = 121.5434, zoom = 16) => {
          // NOTE zoom max 18? default 13
          const map = L.map('map').setView([lat, lng], zoom);

          //   https://wiki.openstreetmap.org/wiki/Tile_servers
          L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution:
              '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }).addTo(map);

          L.marker([lat, lng]).addTo(map).bindPopup('您的位置').openPopup();
          L.marker([25.03382, 121.5434]).addTo(map).bindPopup('資策會');
        };

        mapRender();

        */

      // NOTE render info into page by using geoLocation & geoReverse
      let curCircle; //避免重複點擊時效果疊加 會於下列函式中 先remove 後再次給值
      const fetchLocationInfo = async () => {
        try {
          titleText.innerText = '計算中';

          const geoInfo = await geoLocation();
          const { latitude: lat } = geoInfo.coords; // 緯度 -> 重新命名為 lat
          const { longitude: lng } = geoInfo.coords; //經度 -> 重新命名為 lng
          const { accuracy } = geoInfo.coords; //準確度(誤差值) 以meters(公尺)為單位
          // const { latitude: lat, longitude: lng, accuracy } = geoInfo.coords;

          const cityInfo = await geoReverse(lat, lng);

          let { city } = cityInfo; //所在城市 e.g.台北市 (因桃園改為市 因此這邊改設為let)
          let { locality } = cityInfo; //所在區  e.g. 中正區  (因桃園改為市 因此這邊改設為let)

          // fix 桃園改名
          if (city === '桃園縣') {
            city = '桃園市';
            locality = locality.slice(0, -1) + '區';
          }

          // from geoLocation
          latText.innerText = lat.toFixed(5);
          lngText.innerText = lng.toFixed(5);
          accuracyText.innerText = accuracy.toFixed(1) + ' (米)';
          // from geoReverse
          cityText.innerText = city;
          localityText.innerText = locality;
          // for title
          titleText.innerText = '您的位置是在:';
          // for btn
          geoBtn.innerText = '點擊再次尋找 🚴‍♂️';
          geoBtn.classList.add('geo_btn_shine');

          // current location popup
          L.marker([lat, lng]).addTo(map).bindPopup('您的當前位置').openPopup();
          // NOTE 紅圈

          curCircle?.remove();
          curCircle = L.circle([lat, lng], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.1,
            // Radius of the circle, in meters.
            // 半徑2.5公里 綜合五公里
            radius: 2500,
          })
            .addTo(map)
            .bindPopup('紅圈範圍');

          // 跳到當前位置 zoom 改為13 放大範圍
          map.flyTo([lat, lng], 14);
        } catch (err) {
          alert(err.message);
        }
      };

      geoBtn.addEventListener('click', fetchLocationInfo);
    </script>

    <!-- WARN end -->
    <script src="js/jquery-3.6.0.js"></script>
    <script src="bootstrap4/js/bootstrap.bundle.js"></script>
  </body>
</html>
