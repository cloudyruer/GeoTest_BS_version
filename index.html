<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- fontawsome -->
    <link rel="stylesheet" href="fontawesome/css/all.css" />
    <!-- bootstrap 4.6 -->
    <link rel="stylesheet" href="bootstrap4/css/bootstrap.css" />

    <style>
      body {
        background-color: #151b29;
      }

      .geo_box {
        color: #ffa260;
        border: 2px solid;
        border-radius: 5px;
      }

      .info {
        font-size: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 1rem;
        font-weight: bold;
      }

      .geo_btn {
        background: none;
        color: #ffa260;
        border: 2px solid;
        transition: all 0.2s;
        font-size: 1.3rem;
        font-weight: 600;
        border-radius: 20px;
      }

      .geo_btn:hover {
        border-color: #f1ff5c;
        color: #f1ff5c;
        box-shadow: 0 0.5rem 0.5rem -0.4rem #f1ff5c;
        transform: translateY(-0.25rem);
        animation-play-state: paused;
      }

      .geo_btn:active {
        transform: translateY(0);
      }

      .geo_btn_shine {
        border-color: #f1ff5c;
        color: #f1ff5c;
        box-shadow: 0 0.5rem 0.5rem -0.4rem #f1ff5c;
        transform: translateY(-0.25rem);
        animation: btnPopping 0.8s linear infinite alternate;
      }

      @keyframes btnPopping {
        from {
          transform: translateY(-0.25rem);
          box-shadow: 0rem 0.3rem 1.5rem 0rem #f1ff5c;
        }
        to {
          transform: translateY(0);
          box-shadow: 0 0.5rem 0.3rem -0.6rem #f1ff5c;
        }
      }
    </style>
    <!-- NOTE title -->
    <title>Title</title>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <!-- NOTE -->
        <a class="navbar-brand" href="#">Team &#923;</a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <!-- left side -->
          <ul class="navbar-nav mr-auto">
            <!-- NOTE temp éœ€è¦çš„è©±è¤‡è£½å°±å¥½ ä¸è¦å‹•é€™å€‹ li-->
            <li class="nav-item active">
              <a class="nav-link" href="#">Member : </a>
            </li>
          </ul>

          <!-- right side -->
          <ul class="navbar-nav">
            <!-- after log in,  will show up after login -->

            <li class="nav-item active">
              <a class="nav-link">çš®å¡ä¸˜</a>
            </li>

            <!-- NOTE  add $activeLi ternary-->
            <li class="nav-item">
              <a class="nav-link" href="#">ç·¨è¼¯å€‹äººè³‡æ–™</a>
            </li>

            <!-- log out -->
            <li class="nav-item">
              <a class="nav-link" href="#">ç™»å‡º</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- navbar end -->
    <!-- NOTE start -->
    <div class="container mt-3 mt-md-5">
      <div class="row">
        <div class="col-md-6 col-lg-4">
          <div
            class="
              geo_box
              d-flex
              flex-column
              justify-content-center
              align-items-center
              px-5
            "
          >
            <h3 class="title my-3 font-weight-bold">æ‰€åœ¨ä½ç½®</h3>
            <div class="info w-100 px-1">
              ç·¯åº¦:<span class="lat">å¾…ç¢ºèª</span>
            </div>
            <div class="info w-100 px-1">
              ç¶“åº¦:<span class="lng">å¾…ç¢ºèª</span>
            </div>
            <div class="info w-100 px-1">
              åŸå¸‚:<span class="city">å¾…ç¢ºèª</span>
            </div>
            <div class="info w-100 px-1">
              å€åŸŸ: <span class="locality">å¾…ç¢ºèª</span>
            </div>
            <!-- for test -->
            <div class="info w-100 px-1">
              èª¤å·®:<span class="accuracy">å¾…ç¢ºèª</span>
            </div>
            <button class="geo_btn mt-2 mb-4 w-100 py-3">é»æ“Šå¾Œé–‹å§‹è¨ˆç®—</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const titleText = document.querySelector('.title');
      const latText = document.querySelector('.lat');
      const lngText = document.querySelector('.lng');
      const cityText = document.querySelector('.city');
      const localityText = document.querySelector('.locality');
      const accuracyText = document.querySelector('.accuracy');
      const geoBtn = document.querySelector('.geo_btn');

      // NOTE ç€è¦½å™¨API å–å¾—ç•¶å‰åœ°ç†åº§æ¨™
      const newWhereAmI = () =>
        new Promise((resolve, reject) => {
          // WARN æ­¤ç‚ºè¨­å®šæª” è¦å†è¨è«–
          const options = {
            enableHighAccuracy: true,
            // WARN timeout:won't return until the position is available
            // maybe change to 5000?
            timeout: Infinity,
            maximumAge: 0,
          };

          navigator.geolocation.getCurrentPosition(resolve, reject, options);
        });

      // NOTE  geo reverse å–å¾—ç•¶å‰åœ°ç†ä½ç½®
      const geoReverse = ([lat, lng, accuracy]) => {
        fetch(
          `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=zh`
        )
          .then(res => res.json())
          .then(data => {
            console.log('--geoReverse Success--');
            console.log(data); // geoReverse çµæœ

            let { city } = data; //æ‰€åœ¨åŸå¸‚ e.g.å°åŒ—å¸‚ (å› æ¡ƒåœ’æ”¹ç‚ºå¸‚ å› æ­¤é€™é‚Šæ”¹è¨­ç‚ºlet)
            let { locality } = data; //æ‰€åœ¨å€  e.g. ä¸­æ­£å€  (å› æ¡ƒåœ’æ”¹ç‚ºå¸‚ å› æ­¤é€™é‚Šæ”¹è¨­ç‚ºlet)

            // fix æ¡ƒåœ’æ”¹å
            if (city === 'æ¡ƒåœ’ç¸£') {
              city = 'æ¡ƒåœ’å¸‚';
              locality = locality.slice(0, -1) + 'å€';
            }

            console.log(lat, lng, city, locality);

            // from newWhereAmI
            latText.innerText = lat.toFixed(5);
            lngText.innerText = lng.toFixed(5);
            accuracyText.innerText = accuracy.toFixed(1) + ' (ç±³)';
            // from geoReverse
            cityText.innerText = city;
            localityText.innerText = locality;
            // for title
            titleText.innerText = 'æ‚¨çš„ä½ç½®æ˜¯åœ¨:';

            geoBtn.innerText = 'é»æ“Šå†æ¬¡è¨ˆç®— ğŸš´â€â™‚ï¸';
            geoBtn.classList.add('geo_btn_shine');
          });
      };

      const fetchLocationInfo = () => {
        // NOTE æ²’æœ‰è¨­å®šreject
        newWhereAmI()
          .then(pos => {
            const { latitude: lat } = pos.coords; // ç·¯åº¦ -> é‡æ–°å‘½åç‚º lat
            const { longitude: lng } = pos.coords; //ç¶“åº¦ -> é‡æ–°å‘½åç‚º lng
            const { accuracy } = pos.coords; //æº–ç¢ºåº¦(èª¤å·®å€¼) ä»¥meters(å…¬å°º)ç‚ºå–®ä½
            //   const { latitude: lat, longitude: lng, accuracy } = pos.coords;
            console.log('By Promise:');
            console.log(`ç•¶å‰ç·¯åº¦: ${lat}`);
            console.log(`ç•¶å‰ç¶“åº¦: ${lng}`);
            console.log(`ç•¶å‰èª¤å·®å€¼: ${accuracy}(å–®ä½ç±³)`);
            // return [lat.toFixed(5), lng.toFixed(5)];
            // return [lat, lng];

            // NOTE æ¸¬è©¦ç”¨: åŠ å…¥ èª¤å·®å€¼ accuracy
            console.log(['fetchLocationInfo', lat, lng, accuracy]);
            return [lat, lng, accuracy];
          })
          .then(res => geoReverse(res));
      };

      geoBtn.addEventListener('click', () => {
        titleText.innerText = 'è¨ˆç®—ä¸­';
        fetchLocationInfo();
      });
    </script>

    <!-- WARN end -->
    <script src="js/jquery-3.6.0.js"></script>
    <script src="bootstrap4/js/bootstrap.bundle.js"></script>
  </body>
</html>
